# CIP 0005: Direct Announce

- Date: 2020-02-11
- Author: @kevjue (with a lot of feedback and ideas from @timmoreton, @m-chrzan, @tkporter)
- Status: WIP

## Overview

This CIP is to address some of the current resource requirements of Celo's blockchain's announce protocol.  That protocol's main goal is to distribute each validator's enodeURL(s) to all the other validators, so that they can create direct TCP connections among each other (effectively create an overlay network among the validators).  This overlay network is then used by the Celo's IBFT consensus algorithm to reach consensus on block proposals.

The validator enodeURLs do need to be encrypted when transmitted over the wire, as we want to minimize the number of entities that are aware of it to reduce the change of a DOS attack on our validators.  To that end, the enodeURLs needs to be encrypted with each of the remote validators' public key when sent over the wire.  Consequently, each validator will need to share data that is O(N<sup>2</sup>) size.

The ultimate "end user" goals for this CIP are the following:

1) Minimize bandwidth requirements for our full nodes.  Some of our potential full node operators need to use ISPs that have expensive networking rates.  We need to ensure that adoption of our full nodes is as broad and diverse as possible, so that our consumer end users will have good access to our blockchain via the mobile light client.
2) Maintain a healthy overlay network for IBFT.   This is to maximize consistent block times, which obviously has direct impact to our consumer end users.

This CIP is an iteration of the Announce protocol that is implemented in https://github.com/celo-org/celo-blockchain/pull/816.  The original protocol does optimize for 2), but not for 1).

## Goals

- Reduce bandwidth requirements of our full nodes.
- Maximize availability of the IBFT overlay network.

## Proposed Solution

The announce protocol has to be able to deal with two fundamental faulty scenarios.  For a given validator pair, when only one of the validators has the correct enodeURL of the other (the asymmetric ignorance case) and when both of the validators don't have the correct enodeURL of the other (the mutual ignorance case).

To deal with these cases, this proposal proposes adding the following high level components to the existing Announce protocol.  Add the capability for a validator to directly communicate to another remote validator it's assigned enodeURL, add fast discovery of validator enode mapping changes, and add capability for a validator to query another validator for it's assigned enodeURL via gossip.  Details of these components are in the subsections below.

The asymmetric ignorance case can then be handled by having the validators directly communicate to each remote validator it's assigned enodeURL whenever the enodeURL mapping is updated.  Note that this will need to happen for all remote validators, even if the assigned URL is not updated for a subset of the validators, since all validators will need to know what is the updated version number.  Also, this direct communication will need to be handled when there is and is not an existing connection between validators.

The mutual ignorance case can be handled by having each validator monitor when a validator enode mapping changes, and when it realizes that it's changed, it will gossip a query message to the validator with the updated enodeURL mapping.  That validator will then directly communicate the assigned enodeURL to the querying validator.

### Direct communication of assigned enodeURL

This component will include the following changes:

1)  Announce message format will need to be changed so that only one authenticated and encrypted enodeURL (along with the version number) can be put in the message payload
2)  On enodeURL mapping update, validator will send to all it's the connected validators the appropriate announce message.
3)  On enodeURL mapping update, validator will establish a validator connection with all  Whenever the enodeURL mapping is updated, a validator will either send this announce message to all of it's connected validators (note that this needs to be sent to all validators even if their assigned enodeURL did not change, so that they can update their version number for that validator) or establish a validator connection to the other validator and include the message announce in the connection handshake.

To deal with the mutual ignorance case

This CIP introduces a new protocol "primitive".  Specifically, it introduces the notion of a validator to directly communicate with 

## Alternative Solutions

Other solutions you considered, and how they relate to the solution above.

## Risks

Highlight any risks and concerns that may affect consensus, proof-of-stake, governance, protocol economics, the stability protocol, security, and privacy.

## Useful Links

* Optional section
* Links to related CIPs or other documents

## Implementation

* To follow.
* Or a link to a PR.

Add any implementation considerations here. For all proposals going through the governance process, this section should reference the code implementing the proposed change. Itâ€™s recommended to get community feedback before writing any code.
